<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>í†µí•©ìƒë‹´ ì‹ ì²­</title>
    <th:block layout:fragment="css">
        <style>
            /* í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
            .consultation-container {
                max-width: 1000px;
                margin: 0 auto;
                padding: 40px 20px;
            }

            /* í˜ì´ì§€ í—¤ë” */
            .consultation-header {
                margin-bottom: 40px;
                text-align: center;
            }

            .consultation-header h1 {
                font-size: 36px;
                font-weight: 700;
                color: #2C5F5D;
                margin-bottom: 12px;
            }

            .consultation-header p {
                font-size: 16px;
                color: #666;
                line-height: 1.6;
            }

            /* ì•ˆë‚´ ë°•ìŠ¤ */
            .info-box {
                background: #f8f9fa;
                border-left: 4px solid #2C5F5D;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
            }

            .info-box h3 {
                font-size: 16px;
                font-weight: 600;
                color: #2C5F5D;
                margin-bottom: 12px;
            }

            .info-box ul {
                margin: 0;
                padding-left: 20px;
                color: #495057;
                font-size: 14px;
                line-height: 1.8;
            }

            /* í¼ ì»¨í…Œì´ë„ˆ */
            .consultation-form {
                background: white;
                padding: 40px;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            }

            /* í¼ ê·¸ë£¹ */
            .form-group {
                margin-bottom: 28px;
            }

            .form-group label {
                display: block;
                font-size: 15px;
                font-weight: 600;
                color: #212529;
                margin-bottom: 10px;
            }

            .form-group label .required {
                color: #dc3545;
                margin-left: 4px;
            }

            .form-group .help-text {
                font-size: 13px;
                color: #6c757d;
                margin-top: 6px;
            }

            /* ì…ë ¥ í•„ë“œ */
            .form-control {
                width: 100%;
                padding: 12px 16px;
                font-size: 15px;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                transition: all 0.2s ease;
                box-sizing: border-box;
            }

            .form-control:focus {
                outline: none;
                border-color: #2C5F5D;
                box-shadow: 0 0 0 3px rgba(44, 95, 93, 0.1);
            }

            textarea.form-control {
                min-height: 150px;
                resize: vertical;
                font-family: inherit;
            }

            /* ìƒë‹´ ìœ í˜• ì„ íƒ */
            .consultation-type-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
                margin-top: 10px;
            }

            .type-option {
                position: relative;
            }

            .type-option input[type="radio"] {
                position: absolute;
                opacity: 0;
            }

            .type-option label {
                display: block;
                padding: 16px;
                background: #f8f9fa;
                border: 2px solid #dee2e6;
                border-radius: 8px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                font-weight: 600;
                color: #495057;
                margin-bottom: 0;
            }

            .type-option input[type="radio"]:checked + label {
                background: #2C5F5D;
                border-color: #2C5F5D;
                color: white;
            }

            .type-option label:hover {
                border-color: #2C5F5D;
                background: #e8f5f1;
            }

            .type-option input[type="radio"]:checked + label:hover {
                background: #1f4543;
            }

            /* ë‚ ì§œ/ì‹œê°„ ê·¸ë¦¬ë“œ */
            .datetime-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            /* ë²„íŠ¼ ê·¸ë£¹ */
            .button-group {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 40px;
                padding-top: 30px;
                border-top: 1px solid #e9ecef;
            }

            .btn {
                padding: 14px 40px;
                font-size: 16px;
                font-weight: 600;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .btn-primary {
                background: #2C5F5D;
                color: white;
            }

            .btn-primary:hover {
                background: #1f4543;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(44, 95, 93, 0.3);
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
            }

            /* ì—ëŸ¬ ë©”ì‹œì§€ */
            .error-message {
                color: #dc3545;
                font-size: 13px;
                margin-top: 6px;
                display: none;
            }

            .form-control.error {
                border-color: #dc3545;
            }

            .form-control.error:focus {
                box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
            }

            /* ë§í¬ ë°•ìŠ¤ */
            .links-box {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-top: 30px;
                text-align: center;
            }

            .links-box a {
                color: #2C5F5D;
                text-decoration: none;
                font-weight: 600;
                margin: 0 12px;
                transition: color 0.2s ease;
            }

            .links-box a:hover {
                color: #1f4543;
                text-decoration: underline;
            }

            /* ë°˜ì‘í˜• */
            @media (max-width: 768px) {
                .consultation-form {
                    padding: 24px;
                }

                .consultation-header h1 {
                    font-size: 28px;
                }

                .consultation-type-grid {
                    grid-template-columns: 1fr;
                }

                .datetime-grid {
                    grid-template-columns: 1fr;
                }

                .button-group {
                    flex-direction: column;
                }

                .btn {
                    width: 100%;
                }
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="consultation-container">
        <!-- í—¤ë” -->
        <div class="consultation-header">
            <h1>ğŸŒŸ í†µí•©ìƒë‹´ ì‹ ì²­</h1>
            <p>í•™ì—…, ì§„ë¡œ, ì‹¬ë¦¬ ë“± ë‹¤ì–‘í•œ ë¶„ì•¼ì˜ ì „ë¬¸ ìƒë‹´ì„ ë°›ì•„ë³´ì„¸ìš”.<br>
                ìƒë‹´ì‚¬ê°€ ì—¬ëŸ¬ë¶„ì˜ ê³ ë¯¼ì„ í•¨ê»˜ ë‚˜ëˆ„ê³  í•´ê²°ì±…ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤.</p>
        </div>

        <!-- ì•ˆë‚´ ë°•ìŠ¤ -->
        <div class="info-box">
            <h3>ğŸ“‹ ìƒë‹´ ì‹ ì²­ ì•ˆë‚´</h3>
            <ul>
                <li>ìƒë‹´ ì‹ ì²­ í›„ ë‹´ë‹¹ ìƒë‹´ì‚¬ê°€ ë°°ì •ë©ë‹ˆë‹¤.</li>
                <li>ìƒë‹´ì‚¬ ë°°ì • í›„ í™•ì •ëœ ì¼ì‹œë¥¼ ì•Œë¦¼ìœ¼ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.</li>
                <li>ê¸´ê¸‰í•œ ê²½ìš° í•™ìƒìƒë‹´ì„¼í„°(â˜ 000-0000)ë¡œ ì§ì ‘ ì—°ë½ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
                <li>ì‹ ì²­í•˜ì‹  ìƒë‹´ì€ 'ë‚´ ìƒë‹´ ë‚´ì—­'ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </div>

        <!-- ìƒë‹´ ì‹ ì²­ í¼ -->
        <form class="consultation-form" id="consultationForm" onsubmit="submitConsultation(event)">
            <!-- ìƒë‹´ ìœ í˜• -->
            <div class="form-group">
                <label>ìƒë‹´ ìœ í˜•<span class="required">*</span></label>
                <div class="consultation-type-grid">
                    <div class="type-option">
                        <input type="radio" name="consultationType" id="type-career" value="CAREER" required>
                        <label for="type-career">
                            <i class="fas fa-briefcase"></i><br>
                            ì§„ë¡œìƒë‹´
                        </label>
                    </div>
                    <div class="type-option">
                        <input type="radio" name="consultationType" id="type-academic" value="ACADEMIC">
                        <label for="type-academic">
                            <i class="fas fa-book"></i><br>
                            í•™ì—…ìƒë‹´
                        </label>
                    </div>
                    <div class="type-option">
                        <input type="radio" name="consultationType" id="type-psychological" value="PSYCHOLOGICAL">
                        <label for="type-psychological">
                            <i class="fas fa-heart"></i><br>
                            ì‹¬ë¦¬ìƒë‹´
                        </label>
                    </div>
                    <div class="type-option">
                        <input type="radio" name="consultationType" id="type-relationship" value="RELATIONSHIP">
                        <label for="type-relationship">
                            <i class="fas fa-users"></i><br>
                            ëŒ€ì¸ê´€ê³„
                        </label>
                    </div>
                    <div class="type-option">
                        <input type="radio" name="consultationType" id="type-other" value="OTHER">
                        <label for="type-other">
                            <i class="fas fa-comment"></i><br>
                            ê¸°íƒ€
                        </label>
                    </div>
                </div>
                <div class="error-message" id="error-consultationType">ìƒë‹´ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>

            <!-- í¬ë§ ìƒë‹´ ë‚ ì§œ ë° ì‹œê°„ -->
            <div class="form-group">
                <label>í¬ë§ ìƒë‹´ ì¼ì‹œ<span class="required">*</span></label>
                <div class="datetime-grid">
                    <div>
                        <input type="date" class="form-control" name="requestedDate" id="requestedDate" required>
                        <div class="error-message" id="error-requestedDate">í¬ë§ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div>
                        <input type="time" class="form-control" name="requestedTime" id="requestedTime">
                        <div class="help-text">ì‹œê°„ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ìƒë‹´ì‚¬ì™€ í˜‘ì˜í•˜ì—¬ ê²°ì •ë©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <!-- ìƒë‹´ ì œëª© -->
            <div class="form-group">
                <label for="title">ìƒë‹´ ì œëª©<span class="required">*</span></label>
                <input type="text" class="form-control" name="title" id="title"
                       placeholder="ìƒë‹´ ì£¼ì œë¥¼ ê°„ë‹¨íˆ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: ì§„ë¡œ ê³ ë¯¼, ì„±ì  í–¥ìƒ ë°©ë²• ë“±)"
                       maxlength="200" required>
                <div class="help-text">ìµœëŒ€ 200ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                <div class="error-message" id="error-title">ìƒë‹´ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>

            <!-- ìƒë‹´ ë‚´ìš© -->
            <div class="form-group">
                <label for="content">ìƒë‹´ ë‚´ìš©<span class="required">*</span></label>
                <textarea class="form-control" name="content" id="content"
                          placeholder="ìƒë‹´ë°›ê³  ì‹¶ì€ ë‚´ìš©ì„ ìì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”. êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì‹¤ìˆ˜ë¡ ë” ë„ì›€ì´ ë˜ëŠ” ìƒë‹´ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                          maxlength="2000" required></textarea>
                <div class="help-text">ìµœëŒ€ 2000ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. (<span id="charCount">0</span>/2000)</div>
                <div class="error-message" id="error-content">ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i> ë’¤ë¡œê°€ê¸°
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> ìƒë‹´ ì‹ ì²­í•˜ê¸°
                </button>
            </div>
        </form>

        <!-- ë§í¬ ë°•ìŠ¤ -->
        <div class="links-box">
            <a href="/counseling/list"><i class="fas fa-list"></i> ë‚´ ìƒë‹´ ë‚´ì—­</a>
            <a href="/"><i class="fas fa-home"></i> í™ˆìœ¼ë¡œ</a>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        // ë‚ ì§œ ìµœì†Œê°’ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('requestedDate').setAttribute('min', today);

        // ê¸€ì ìˆ˜ ì¹´ìš´í„°
        const contentTextarea = document.getElementById('content');
        const charCountSpan = document.getElementById('charCount');

        contentTextarea.addEventListener('input', function() {
            charCountSpan.textContent = this.value.length;
        });

        // í¼ ì œì¶œ ì²˜ë¦¬
        async function submitConsultation(event) {
            event.preventDefault();

            // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));

            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const formData = new FormData(event.target);
            const consultationType = formData.get('consultationType');
            const requestedDate = formData.get('requestedDate');
            const requestedTime = formData.get('requestedTime');
            const title = formData.get('title');
            const content = formData.get('content');

            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìœ íš¨ì„± ê²€ì¦
            let hasError = false;

            if (!consultationType) {
                showError('consultationType', 'ìƒë‹´ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                hasError = true;
            }

            if (!requestedDate) {
                showError('requestedDate', 'í¬ë§ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                hasError = true;
            }

            if (!title || title.trim() === '') {
                showError('title', 'ìƒë‹´ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                hasError = true;
            }

            if (!content || content.trim() === '') {
                showError('content', 'ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                hasError = true;
            }

            if (hasError) {
                return;
            }

            // API ìš”ì²­ ë°ì´í„°
            const requestData = {
                consultationType: consultationType,
                requestedDate: requestedDate,
                requestedTime: requestedTime || null,
                title: title.trim(),
                content: content.trim()
            };

            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‹ ì²­ ì¤‘...';

                // API í˜¸ì¶œ
                const response = await fetch('/api/consultations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('ìƒë‹´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹´ë‹¹ ìƒë‹´ì‚¬ê°€ ë°°ì •ë˜ë©´ ì•Œë¦¼ìœ¼ë¡œ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                    window.location.href = '/counseling/list';
                } else {
                    alert(data.error || 'ìƒë‹´ ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ìƒë‹´ ì‹ ì²­í•˜ê¸°';
                }
            } catch (error) {
                console.error('ìƒë‹´ ì‹ ì²­ ì‹¤íŒ¨:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ìƒë‹´ ì‹ ì²­í•˜ê¸°';
            }
        }

        // ì—ëŸ¬ í‘œì‹œ í•¨ìˆ˜
        function showError(fieldName, message) {
            const errorElement = document.getElementById('error-' + fieldName);
            const inputElement = document.getElementById(fieldName) || document.querySelector(`input[name="${fieldName}"]`);

            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            if (inputElement) {
                inputElement.classList.add('error');
            }
        }
    </script>
</th:block>
</body>
</html>
