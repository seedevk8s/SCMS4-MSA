<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}">
<head>
    <title>ë§ˆì¼ë¦¬ì§€ ê´€ë¦¬</title>
    <th:block layout:fragment="css">
        <style>
            .admin-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
            }

            .admin-header h1 {
                font-size: 28px;
                font-weight: 700;
                color: #172B4D;
            }

            .btn-primary {
                background: #2C5F5D;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.3s;
            }

            .btn-primary:hover {
                background: #1a3d3b;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 13px;
                cursor: pointer;
                margin-right: 5px;
            }

            .btn-danger {
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 13px;
                cursor: pointer;
            }

            .tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 30px;
                border-bottom: 2px solid #DFE1E6;
            }

            .tab-button {
                padding: 12px 24px;
                background: none;
                border: none;
                border-bottom: 3px solid transparent;
                color: #6B778C;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }

            .tab-button:hover {
                color: #2C5F5D;
            }

            .tab-button.active {
                color: #2C5F5D;
                border-bottom-color: #2C5F5D;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .data-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                overflow: hidden;
            }

            .data-table thead {
                background: #F4F5F7;
            }

            .data-table th {
                padding: 16px;
                text-align: left;
                font-size: 14px;
                font-weight: 600;
                color: #172B4D;
                border-bottom: 2px solid #DFE1E6;
            }

            .data-table td {
                padding: 16px;
                border-bottom: 1px solid #DFE1E6;
                color: #42526E;
            }

            .data-table tr:hover {
                background-color: #F4F5F7;
            }

            .badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }

            .badge-active {
                background: #E3FCEF;
                color: #006644;
            }

            .badge-inactive {
                background: #FFEBE6;
                color: #BF2600;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .modal.active {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .modal-content {
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            }

            .modal-header {
                font-size: 20px;
                font-weight: 700;
                color: #172B4D;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 600;
                color: #172B4D;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #DFE1E6;
                border-radius: 6px;
                font-size: 14px;
            }

            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
            }

            .alert {
                padding: 16px;
                border-radius: 8px;
                margin-bottom: 20px;
            }

            .alert-success {
                background: #E3FCEF;
                border: 1px solid #36B37E;
                color: #006644;
            }

            .alert-error {
                background: #FFEBE6;
                border: 1px solid #DE350B;
                color: #BF2600;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="admin-header">
        <h1>ğŸ† CHAMP ë§ˆì¼ë¦¬ì§€ ê´€ë¦¬</h1>
        <div>
            <button class="btn-primary" onclick="openCreateRuleModal()">+ ìƒˆ ê·œì¹™ ì¶”ê°€</button>
            <button class="btn-primary" onclick="openAwardModal()">+ ë§ˆì¼ë¦¬ì§€ ì§€ê¸‰</button>
        </div>
    </div>

    <div id="alert-container"></div>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('rules')">ë§ˆì¼ë¦¬ì§€ ê·œì¹™</button>
        <button class="tab-button" onclick="switchTab('ranking')">í•™ìƒ ë­í‚¹</button>
    </div>

    <!-- íƒ­: ë§ˆì¼ë¦¬ì§€ ê·œì¹™ -->
    <div id="tab-rules" class="tab-content active">
        <table class="data-table">
            <thead>
            <tr>
                <th>í™œë™ íƒ€ì…</th>
                <th>í™œë™ëª…</th>
                <th>í¬ì¸íŠ¸</th>
                <th>ì„¤ëª…</th>
                <th>ìƒíƒœ</th>
                <th>ìƒì„±ì¼</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="rules-table-body">
            <tr th:each="rule : ${rules}">
                <td th:text="${rule.activityType}">PROGRAM</td>
                <td th:text="${rule.activityName}">í”„ë¡œê·¸ë¨ ì°¸ì—¬ ì™„ë£Œ</td>
                <td><strong th:text="${rule.points} + 'P'">100P</strong></td>
                <td th:text="${rule.description}">í”„ë¡œê·¸ë¨ ì°¸ì—¬ë¥¼ ì™„ë£Œí•œ ê²½ìš°</td>
                <td>
                    <span th:class="${rule.isActive ? 'badge badge-active' : 'badge badge-inactive'}"
                          th:text="${rule.isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}">í™œì„±</span>
                </td>
                <td th:text="${#temporals.format(rule.createdAt, 'yyyy-MM-dd')}">2025-01-01</td>
                <td>
                    <button class="btn-secondary" th:onclick="'editRule(' + ${rule.ruleId} + ')'">ìˆ˜ì •</button>
                    <button class="btn-danger" th:onclick="'deleteRule(' + ${rule.ruleId} + ')'">ì‚­ì œ</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- íƒ­: í•™ìƒ ë­í‚¹ -->
    <div id="tab-ranking" class="tab-content">
        <table class="data-table">
            <thead>
            <tr>
                <th>ìˆœìœ„</th>
                <th>í•™ë²ˆ</th>
                <th>ì´ë¦„</th>
                <th>í•™ê³¼</th>
                <th>ì´ ë§ˆì¼ë¦¬ì§€</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="ranking : ${rankings}">
                <td><strong th:text="${ranking.rank}">1</strong></td>
                <td th:text="${ranking.userId}">2024001</td>
                <td th:text="${ranking.name}">í™ê¸¸ë™</td>
                <td th:text="${ranking.department}">ì»´í“¨í„°ê³µí•™ê³¼</td>
                <td><strong th:text="${ranking.totalPoints} + 'P'">1000P</strong></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ëª¨ë‹¬: ê·œì¹™ ìƒì„± -->
    <div id="modal-create-rule" class="modal">
        <div class="modal-content">
            <div class="modal-header">ìƒˆ ë§ˆì¼ë¦¬ì§€ ê·œì¹™ ì¶”ê°€</div>
            <form id="form-create-rule" onsubmit="createRule(event)">
                <div class="form-group">
                    <label>í™œë™ íƒ€ì…</label>
                    <select name="activityType" required>
                        <option value="PROGRAM">í”„ë¡œê·¸ë¨</option>
                        <option value="COUNSELING">ìƒë‹´</option>
                        <option value="SURVEY">ì„¤ë¬¸ì¡°ì‚¬</option>
                        <option value="MANUAL">ìˆ˜ë™</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>í™œë™ëª…</label>
                    <input type="text" name="activityName" required placeholder="ì˜ˆ: í”„ë¡œê·¸ë¨ ì°¸ì—¬ ì™„ë£Œ">
                </div>
                <div class="form-group">
                    <label>í¬ì¸íŠ¸</label>
                    <input type="number" name="points" required placeholder="ì˜ˆ: 100">
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea name="description" rows="3" placeholder="ê·œì¹™ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-create-rule')">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary">ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ë§ˆì¼ë¦¬ì§€ ì§€ê¸‰ -->
    <div id="modal-award" class="modal">
        <div class="modal-content">
            <div class="modal-header">ë§ˆì¼ë¦¬ì§€ ìˆ˜ë™ ì§€ê¸‰</div>
            <form id="form-award" onsubmit="awardMileage(event)">
                <div class="form-group">
                    <label>í•™ìƒ ID (í•™ë²ˆ)</label>
                    <input type="number" name="userId" required placeholder="ì˜ˆ: 2024001">
                </div>
                <div class="form-group">
                    <label>í¬ì¸íŠ¸ (ìŒìˆ˜ ì…ë ¥ì‹œ ì°¨ê°)</label>
                    <input type="number" name="points" required placeholder="ì˜ˆ: 100">
                </div>
                <div class="form-group">
                    <label>í™œë™ëª…</label>
                    <input type="text" name="activityName" required placeholder="ì˜ˆ: íŠ¹ë³„ í™œë™ ì°¸ì—¬">
                </div>
                <div class="form-group">
                    <label>ì‚¬ìœ </label>
                    <textarea name="description" rows="3" required placeholder="ì§€ê¸‰/ì°¨ê° ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('modal-award')">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary">ì§€ê¸‰</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function openCreateRuleModal() {
            document.getElementById('modal-create-rule').classList.add('active');
        }

        function openAwardModal() {
            document.getElementById('modal-award').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createRule(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                activityType: form.activityType.value,
                activityName: form.activityName.value,
                points: parseInt(form.points.value),
                description: form.description.value
            };

            try {
                const response = await fetch('/admin/mileage/api/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('ë§ˆì¼ë¦¬ì§€ ê·œì¹™ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closeModal('modal-create-rule');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('ê·œì¹™ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showAlert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function awardMileage(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                userId: parseInt(form.userId.value),
                points: parseInt(form.points.value),
                activityName: form.activityName.value,
                description: form.description.value
            };

            try {
                const response = await fetch('/admin/mileage/api/award', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('ë§ˆì¼ë¦¬ì§€ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closeModal('modal-award');
                    form.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'ë§ˆì¼ë¦¬ì§€ ì§€ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showAlert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm('ì´ ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/admin/mileage/api/rules/${ruleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('ê·œì¹™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('ê·œì¹™ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showAlert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</div>
</body>
</html>
