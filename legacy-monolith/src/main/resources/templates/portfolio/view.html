<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title th:text="${portfolio.title}">포트폴리오</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="fw-bold" th:text="${portfolio.title}">포트폴리오 제목</h2>
                            <p class="text-muted" th:text="${portfolio.description}">포트폴리오 설명</p>
                        </div>
                        <div th:if="${isOwner}">
                            <a th:href="@{/portfolio/{id}/edit(id=${portfolio.portfolioId})}" class="btn btn-outline-primary me-2">
                                <i class="fas fa-edit"></i> 수정
                            </a>
                            <button class="btn btn-outline-success" onclick="createShareLink()">
                                <i class="fas fa-share"></i> 공유
                            </button>
                        </div>
                    </div>

                    <div class="mt-3">
                        <span class="badge"
                              th:classappend="${portfolio.visibility.name() == 'PUBLIC'} ? 'bg-success' : 'bg-secondary'"
                              th:text="${portfolio.visibility.description}">공개</span>
                        <span class="text-muted ms-3">
                            <i class="fas fa-eye"></i> <span th:text="${portfolio.totalViews} ?: 0">0</span> 조회
                        </span>
                    </div>
                </div>

                <div th:if="${portfolio.items == null or portfolio.items.isEmpty()}" class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 아직 추가된 항목이 없습니다.
                </div>

                <div th:if="${portfolio.items != null and !portfolio.items.isEmpty()}">
                    <div class="card mb-3" th:each="item : ${portfolio.items}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="flex-grow-1">
                                    <h5 class="card-title" th:text="${item.title}">항목 제목</h5>
                                    <p class="text-muted small mb-2">
                                        <span class="badge bg-secondary me-2" th:text="${item.itemType.description}">유형</span>
                                        <span th:if="${item.organization}" th:text="${item.organization}">기관</span>
                                        <span th:if="${item.startDate}">
                                            | <span th:text="${#temporals.format(item.startDate, 'yyyy-MM-dd')}">2024-01-01</span>
                                        </span>
                                        <span th:if="${item.endDate}">
                                            ~ <span th:text="${#temporals.format(item.endDate, 'yyyy-MM-dd')}">2024-01-01</span>
                                        </span>
                                    </p>
                                    <p class="card-text" th:text="${item.description}">항목 설명</p>
                                </div>
                                <div th:if="${isOwner}">
                                    <button class="btn btn-sm btn-outline-danger"
                                            th:onclick="'deleteItem(' + ${item.itemId} + ')'">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <a href="/portfolio" class="btn btn-secondary">목록으로</a>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const portfolioId = [[${portfolio.portfolioId}]];

        function createShareLink() {
            fetch(`/api/portfolios/${portfolioId}/share`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const shareUrl = window.location.origin + '/portfolio/shared/' + data.share.shareToken;
                    prompt('공유 링크가 생성되었습니다. 복사하세요:', shareUrl);
                } else {
                    alert(data.error || '공유 링크 생성 실패');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('공유 링크 생성 실패');
            });
        }

        function deleteItem(itemId) {
            if (!confirm('항목을 삭제하시겠습니까?')) {
                return;
            }

            fetch(`/api/portfolios/${portfolioId}/items/${itemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('항목이 삭제되었습니다.');
                    location.reload();
                } else {
                    alert(data.error || '항목 삭제 실패');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('항목 삭제 실패');
            });
        }
    </script>
</div>
</body>
</html>
