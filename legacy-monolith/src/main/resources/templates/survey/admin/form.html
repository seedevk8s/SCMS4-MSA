<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title th:text="${isEdit} ? 'ì„¤ë¬¸ ìˆ˜ì •' : 'ì„¤ë¬¸ ìƒì„±'">ì„¤ë¬¸ ê´€ë¦¬</title>
    <style>
        .question-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        .option-item {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-5">
        <h2 th:text="${isEdit} ? 'ğŸ“ ì„¤ë¬¸ ìˆ˜ì •' : 'ğŸ“ ìƒˆ ì„¤ë¬¸ ë§Œë“¤ê¸°'"></h2>

        <form id="surveyForm">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="card mb-4">
                <div class="card-header"><h5>ê¸°ë³¸ ì •ë³´</h5></div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">ì œëª© *</label>
                        <input type="text" class="form-control" id="title" required maxlength="200"
                               placeholder="ì˜ˆ: 2024ë…„ í•™ìƒ ë§Œì¡±ë„ ì¡°ì‚¬">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì„¤ëª…</label>
                        <textarea class="form-control" id="description" rows="3" maxlength="5000"
                                  placeholder="ì„¤ë¬¸ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì‹œì‘ì¼ì‹œ *</label>
                            <input type="datetime-local" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì¢…ë£Œì¼ì‹œ *</label>
                            <input type="datetime-local" class="form-control" id="endDate" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ìµëª… ì—¬ë¶€</label>
                            <select class="form-select" id="isAnonymous">
                                <option value="false">ì‹¤ëª…</option>
                                <option value="true">ìµëª…</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ëŒ€ìƒ ìœ í˜•</label>
                            <select class="form-select" id="targetType">
                                <option value="ALL">ì „ì²´</option>
                                <option value="STUDENT">í•™ìƒ</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ì¤‘ë³µ ì‘ë‹µ í—ˆìš©</label>
                            <select class="form-select" id="allowMultipleResponses">
                                <option value="false">ë¶ˆí—ˆ</option>
                                <option value="true">í—ˆìš©</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì§ˆë¬¸ ëª©ë¡ -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>ì§ˆë¬¸ ëª©ë¡</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addQuestion()">
                        <i class="fas fa-plus"></i> ì§ˆë¬¸ ì¶”ê°€
                    </button>
                </div>
                <div class="card-body">
                    <div id="questionsContainer"></div>
                </div>
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="d-flex justify-content-between">
                <a href="/survey/admin" class="btn btn-secondary">ì·¨ì†Œ</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> <span th:text="${isEdit} ? 'ìˆ˜ì • ì™„ë£Œ' : 'ìƒì„±í•˜ê¸°'"></span>
                </button>
            </div>
        </form>
    </div>

    <script>
        let questionCounter = 0;

        function addQuestion() {
            const questionId = questionCounter++;
            const html = `
                <div class="question-card" id="question-${questionId}">
                    <div class="d-flex justify-content-between mb-3">
                        <h6>ì§ˆë¬¸ ${questionId + 1}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(${questionId})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì§ˆë¬¸ ìœ í˜•</label>
                        <select class="form-select question-type" data-question-id="${questionId}" onchange="updateQuestionType(${questionId})">
                            <option value="SINGLE_CHOICE">ê°ê´€ì‹ ë‹¨ì¼ì„ íƒ</option>
                            <option value="MULTIPLE_CHOICE">ê°ê´€ì‹ ë³µìˆ˜ì„ íƒ</option>
                            <option value="SHORT_TEXT">ì£¼ê´€ì‹ ë‹¨ë‹µí˜•</option>
                            <option value="LONG_TEXT">ì£¼ê´€ì‹ ì„œìˆ í˜•</option>
                            <option value="SCALE">ì²™ë„í˜• (1-5ì )</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì§ˆë¬¸ ë‚´ìš©</label>
                        <textarea class="form-control question-text" data-question-id="${questionId}" rows="2" required></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input question-required" type="checkbox" data-question-id="${questionId}" checked>
                        <label class="form-check-label">í•„ìˆ˜ ì‘ë‹µ</label>
                    </div>

                    <div class="options-container" id="options-${questionId}">
                        <!-- ê°ê´€ì‹ì¸ ê²½ìš° ì„ íƒì§€ ì¶”ê°€ -->
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-primary add-option-btn" id="add-option-btn-${questionId}" onclick="addOption(${questionId})">
                        <i class="fas fa-plus"></i> ì„ íƒì§€ ì¶”ê°€
                    </button>
                </div>
            `;

            document.getElementById('questionsContainer').insertAdjacentHTML('beforeend', html);
            updateQuestionType(questionId);
        }

        function removeQuestion(questionId) {
            document.getElementById(`question-${questionId}`).remove();
        }

        function updateQuestionType(questionId) {
            const questionType = document.querySelector(`.question-type[data-question-id="${questionId}"]`).value;
            const optionsContainer = document.getElementById(`options-${questionId}`);
            const addOptionBtn = document.getElementById(`add-option-btn-${questionId}`);

            if (questionType === 'SINGLE_CHOICE' || questionType === 'MULTIPLE_CHOICE') {
                optionsContainer.style.display = 'block';
                addOptionBtn.style.display = 'block';
                // ê¸°ë³¸ ì„ íƒì§€ 2ê°œ ì¶”ê°€
                if (optionsContainer.children.length === 0) {
                    addOption(questionId);
                    addOption(questionId);
                }
            } else {
                optionsContainer.style.display = 'none';
                addOptionBtn.style.display = 'none';
            }
        }

        let optionCounters = {};

        function addOption(questionId) {
            if (!optionCounters[questionId]) optionCounters[questionId] = 0;
            const optionId = optionCounters[questionId]++;

            const html = `
                <div class="option-item d-flex gap-2" id="option-${questionId}-${optionId}">
                    <input type="text" class="form-control option-text" data-question-id="${questionId}" data-option-id="${optionId}" placeholder="ì„ íƒì§€ ${optionId + 1}">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeOption(${questionId}, ${optionId})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.getElementById(`options-${questionId}`).insertAdjacentHTML('beforeend', html);
        }

        function removeOption(questionId, optionId) {
            document.getElementById(`option-${questionId}-${optionId}`).remove();
        }

        // í¼ ì œì¶œ
        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // ì§ˆë¬¸ ë°ì´í„° ìˆ˜ì§‘
            const questions = [];
            document.querySelectorAll('.question-card').forEach((card, index) => {
                const questionId = card.id.replace('question-', '');
                const questionType = card.querySelector('.question-type').value;
                const questionText = card.querySelector('.question-text').value;
                const isRequired = card.querySelector('.question-required').checked;

                const question = {
                    questionType: questionType,
                    questionText: questionText,
                    isRequired: isRequired,
                    displayOrder: index,
                    options: []
                };

                // ê°ê´€ì‹ì¸ ê²½ìš° ì„ íƒì§€ ìˆ˜ì§‘
                if (questionType === 'SINGLE_CHOICE' || questionType === 'MULTIPLE_CHOICE') {
                    card.querySelectorAll('.option-text').forEach((optionInput, optionIndex) => {
                        if (optionInput.value.trim()) {
                            question.options.push({
                                optionText: optionInput.value.trim(),
                                displayOrder: optionIndex
                            });
                        }
                    });
                }

                // ì²™ë„í˜•ì¸ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
                if (questionType === 'SCALE') {
                    question.scaleMin = 1;
                    question.scaleMax = 5;
                    question.scaleMinLabel = 'ë§¤ìš° ë‚®ìŒ';
                    question.scaleMaxLabel = 'ë§¤ìš° ë†’ìŒ';
                }

                questions.push(question);
            });

            if (questions.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”');
                return;
            }

            // ì„¤ë¬¸ ë°ì´í„° ìƒì„±
            const surveyData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                isAnonymous: document.getElementById('isAnonymous').value === 'true',
                targetType: document.getElementById('targetType').value,
                allowMultipleResponses: document.getElementById('allowMultipleResponses').value === 'true',
                showResults: false,
                questions: questions
            };

            const isEdit = [[${isEdit}]] || false;
            const surveyId = [[${survey?.surveyId}]];
            const url = isEdit ? `/api/surveys/${surveyId}` : '/api/surveys';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(surveyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '/survey/admin';
                } else {
                    alert(data.error || 'ì²˜ë¦¬ ì‹¤íŒ¨');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            });
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì§ˆë¬¸ 1ê°œ ì¶”ê°€
        window.addEventListener('DOMContentLoaded', function() {
            addQuestion();
        });
    </script>
</div>
</body>
</html>
