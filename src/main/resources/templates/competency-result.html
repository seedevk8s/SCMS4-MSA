<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>ì—­ëŸ‰ì§„ë‹¨ ê²°ê³¼ - SCMS</title>
    <th:block layout:fragment="css">
        <style>
            .assessment-result-container {
                max-width: 1200px;
                margin: 40px auto;
                padding: 0 24px;
            }

            .result-header {
                background: linear-gradient(135deg, #2C5F5D 0%, #3B7573 100%);
                color: white;
                padding: 40px;
                border-radius: 12px;
                margin-bottom: 30px;
                text-align: center;
            }

            .result-header h1 {
                font-size: 32px;
                font-weight: 700;
                margin-bottom: 16px;
            }

            .result-header .student-info {
                font-size: 18px;
                opacity: 0.9;
            }

            .result-header .overall-score {
                font-size: 48px;
                font-weight: 700;
                margin: 20px 0 10px;
            }

            .result-header .overall-grade {
                font-size: 24px;
                font-weight: 600;
                padding: 8px 20px;
                background: rgba(255,255,255,0.2);
                border-radius: 20px;
                display: inline-block;
            }

            .chart-section {
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 24px;
            }

            .chart-title {
                font-size: 20px;
                font-weight: 700;
                color: #2C5F5D;
                margin-bottom: 20px;
                padding-bottom: 12px;
                border-bottom: 2px solid #e8ecf1;
            }

            .chart-container {
                position: relative;
                height: 400px;
                margin: 20px 0;
            }

            .category-scores {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .category-card {
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .category-card h3 {
                font-size: 18px;
                font-weight: 700;
                color: #2C5F5D;
                margin-bottom: 16px;
            }

            .category-score {
                font-size: 36px;
                font-weight: 700;
                color: #3B7573;
                margin-bottom: 8px;
            }

            .category-grade {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
            }

            .grade-A { background: #d4edda; color: #155724; }
            .grade-B { background: #cfe2ff; color: #084298; }
            .grade-C { background: #fff3cd; color: #664d03; }
            .grade-D { background: #f8d7da; color: #842029; }
            .grade-F { background: #f8d7da; color: #842029; }

            .competency-list {
                margin-top: 16px;
            }

            .competency-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid #e8ecf1;
            }

            .competency-item:last-child {
                border-bottom: none;
            }

            .competency-name {
                font-size: 14px;
                color: #495057;
            }

            .competency-score {
                font-size: 16px;
                font-weight: 600;
                color: #2C5F5D;
            }

            .insights-section {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                margin-bottom: 30px;
            }

            .insight-card {
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .insight-card h3 {
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 16px;
            }

            .insight-card.strengths h3 {
                color: #155724;
            }

            .insight-card.weaknesses h3 {
                color: #842029;
            }

            .insight-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .insight-list li {
                padding: 12px;
                margin-bottom: 8px;
                background: #f8f9fa;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .insight-list li .score {
                font-weight: 700;
                font-size: 18px;
            }

            .action-buttons {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 30px;
            }

            .btn {
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                border: none;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                transition: all 0.3s;
            }

            .btn-primary {
                background: #2C5F5D;
                color: white;
            }

            .btn-primary:hover {
                background: #3B7573;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
            }

            .loading {
                text-align: center;
                padding: 60px 20px;
                font-size: 18px;
                color: #6c757d;
            }

            @media print {
                .action-buttons {
                    display: none;
                }
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content" class="assessment-result-container">
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">ë¡œë”© ì¤‘...</span>
            </div>
            <p>ì—­ëŸ‰ í‰ê°€ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- ê²°ê³¼ ì»¨í…Œì´ë„ˆ -->
        <div id="resultContainer" style="display: none;">
            <!-- í—¤ë” -->
            <div class="result-header">
                <h1>ì—­ëŸ‰ í‰ê°€ ê²°ê³¼</h1>
                <div class="student-info">
                    <span id="studentName">-</span> (<span id="studentNumber">-</span>)
                </div>
                <div class="overall-score" id="overallScore">0.0</div>
                <div class="overall-grade" id="overallGrade">-</div>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ -->
            <div class="category-scores" id="categoryScores"></div>

            <!-- ë ˆì´ë” ì°¨íŠ¸ -->
            <div class="chart-section">
                <h2 class="chart-title">ì—­ëŸ‰ í”„ë¡œí•„</h2>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <!-- ê°•ì /ì•½ì  ë¶„ì„ -->
            <div class="insights-section">
                <div class="insight-card strengths">
                    <h3>ğŸŒŸ ì£¼ìš” ê°•ì  (Top 3)</h3>
                    <ul class="insight-list" id="strengthsList"></ul>
                </div>
                <div class="insight-card weaknesses">
                    <h3>ğŸ“ˆ ê°œì„  í•„ìš” (Bottom 3)</h3>
                    <ul class="insight-list" id="weaknessesList"></ul>
                </div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="action-buttons">
                <a href="/programs" class="btn btn-primary">ì¶”ì²œ í”„ë¡œê·¸ë¨ ë³´ê¸°</a>
                <button onclick="window.print()" class="btn btn-secondary">ê²°ê³¼ ì¸ì‡„</button>
                <a href="/mypage" class="btn btn-secondary">ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™</a>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script th:inline="javascript">
            // ì„¸ì…˜ì—ì„œ studentId ê°€ì ¸ì˜¤ê¸°
            const studentId = /*[[${session.userId}]]*/ null;

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ì¡°íšŒ
            document.addEventListener('DOMContentLoaded', function() {
                if (!studentId) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }

                loadAssessmentReport(studentId);
            });

            // í‰ê°€ ë¦¬í¬íŠ¸ ì¡°íšŒ
            async function loadAssessmentReport(studentId) {
                try {
                    const response = await fetch(`/api/assessments/students/${studentId}/report`);

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—­ëŸ‰ ì§„ë‹¨ì„ ì‹¤ì‹œí•´ì£¼ì„¸ìš”.');
                        }
                        throw new Error('í‰ê°€ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const report = await response.json();
                    displayReport(report);

                } catch (error) {
                    console.error('Error loading report:', error);
                    document.getElementById('loading').innerHTML =
                        `<div class="alert alert-danger">${error.message}</div>
                         <div class="action-buttons">
                             <a href="/competency-assessment" class="btn btn-primary">ì—­ëŸ‰ ì§„ë‹¨ ì‹œì‘í•˜ê¸°</a>
                             <a href="/" class="btn btn-secondary">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                         </div>`;
                }
            }

            // ë¦¬í¬íŠ¸ í‘œì‹œ
            function displayReport(report) {
                // ë¡œë”© ìˆ¨ê¸°ê¸°, ê²°ê³¼ í‘œì‹œ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultContainer').style.display = 'block';

                // í•™ìƒ ì •ë³´
                document.getElementById('studentName').textContent = report.studentName;
                document.getElementById('studentNumber').textContent = report.studentNumber;

                // ì „ì²´ ì ìˆ˜
                document.getElementById('overallScore').textContent = report.totalScore.toFixed(1);
                document.getElementById('overallGrade').textContent = `ë“±ê¸‰: ${report.overallGrade}`;

                // ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ ì¹´ë“œ
                displayCategoryScores(report.categoryScores);

                // ë ˆì´ë” ì°¨íŠ¸
                displayRadarChart(report.categoryScores);

                // ê°•ì /ì•½ì 
                displayStrengths(report.strengths);
                displayWeaknesses(report.weaknesses);
            }

            // ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ ì¹´ë“œ
            function displayCategoryScores(categoryScores) {
                const container = document.getElementById('categoryScores');
                container.innerHTML = '';

                categoryScores.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'category-card';

                    let competenciesHTML = '';
                    category.competencies.forEach(comp => {
                        competenciesHTML += `
                            <div class="competency-item">
                                <span class="competency-name">${comp.competencyName}</span>
                                <span class="competency-score">${comp.score}ì </span>
                            </div>
                        `;
                    });

                    card.innerHTML = `
                        <h3>${category.categoryName}</h3>
                        <div class="category-score">${category.averageScore.toFixed(1)}ì </div>
                        <span class="category-grade grade-${category.grade}">ë“±ê¸‰: ${category.grade}</span>
                        <div class="competency-list">${competenciesHTML}</div>
                    `;

                    container.appendChild(card);
                });
            }

            // ë ˆì´ë” ì°¨íŠ¸
            function displayRadarChart(categoryScores) {
                const ctx = document.getElementById('radarChart').getContext('2d');

                const labels = categoryScores.map(c => c.categoryName);
                const data = categoryScores.map(c => c.averageScore);

                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì—­ëŸ‰ ì ìˆ˜',
                            data: data,
                            fill: true,
                            backgroundColor: 'rgba(44, 95, 93, 0.2)',
                            borderColor: 'rgb(44, 95, 93)',
                            pointBackgroundColor: 'rgb(44, 95, 93)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(44, 95, 93)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                ticks: {
                                    stepSize: 20
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

            // ê°•ì  í‘œì‹œ
            function displayStrengths(strengths) {
                const list = document.getElementById('strengthsList');
                list.innerHTML = '';

                strengths.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${item.competencyName}</span>
                        <span class="score" style="color: #155724;">${item.score}ì </span>
                    `;
                    list.appendChild(li);
                });
            }

            // ì•½ì  í‘œì‹œ
            function displayWeaknesses(weaknesses) {
                const list = document.getElementById('weaknessesList');
                list.innerHTML = '';

                weaknesses.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${item.competencyName}</span>
                        <span class="score" style="color: #842029;">${item.score}ì </span>
                    `;
                    list.appendChild(li);
                });
            }
        </script>
    </th:block>
</body>
</html>
