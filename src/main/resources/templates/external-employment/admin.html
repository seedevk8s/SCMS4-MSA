<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>외부취업 가점 관리 (관리자)</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid mt-5">
        <h2 class="fw-bold mb-4"><i class="fas fa-user-cog"></i> 외부취업 가점 관리</h2>

        <!-- 통계 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5>전체 신청</h5>
                        <h2 id="totalCount">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h5>승인 대기</h5>
                        <h2 id="pendingCount">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5>승인 완료</h5>
                        <h2 id="verifiedCount">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5>총 부여 가점</h5>
                        <h2 id="totalCredits">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- 탭 -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#pending">
                    승인 대기 <span class="badge bg-warning" id="pendingBadge">0</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#verified">
                    승인 완료 <span class="badge bg-success" id="verifiedBadge">0</span>
                </a>
            </li>
        </ul>

        <div class="tab-content mt-4">
            <!-- 승인 대기 탭 -->
            <div class="tab-pane fade show active" id="pending">
                <div id="pendingList"></div>
            </div>

            <!-- 승인 완료 탭 -->
            <div class="tab-pane fade" id="verified">
                <div id="verifiedList"></div>
            </div>
        </div>
    </div>

    <!-- 승인/거절 모달 -->
    <div class="modal fade" id="verifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">활동 검토</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modalEmploymentInfo"></div>

                    <div class="mb-3">
                        <label for="creditsInput" class="form-label">부여할 가점</label>
                        <input type="number" class="form-control" id="creditsInput" min="0">
                        <small class="text-muted">0을 입력하면 자동 계산됩니다.</small>
                    </div>

                    <div class="mb-3" id="rejectionReasonDiv" style="display:none;">
                        <label for="rejectionReasonInput" class="form-label">거절 사유</label>
                        <textarea class="form-control" id="rejectionReasonInput" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">거절</button>
                    <button type="button" class="btn btn-success" id="approveBtn">승인</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let currentEmploymentId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadPendingEmployments();
            loadVerifiedEmployments();
        });

        function loadStatistics() {
            fetch('/api/external-employments/admin/statistics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalCount').textContent = data.totalCount;
                    document.getElementById('pendingCount').textContent = data.pendingCount;
                    document.getElementById('verifiedCount').textContent = data.verifiedCount;
                    document.getElementById('totalCredits').textContent = data.totalCredits;
                    document.getElementById('pendingBadge').textContent = data.pendingCount;
                    document.getElementById('verifiedBadge').textContent = data.verifiedCount;
                })
                .catch(error => console.error('통계 로드 실패:', error));
        }

        function loadPendingEmployments() {
            fetch('/api/external-employments/admin/pending?page=0&size=50')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('pendingList');
                    if (data.content.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">승인 대기 중인 활동이 없습니다.</div>';
                        return;
                    }

                    container.innerHTML = data.content.map(e => createEmploymentCard(e, true)).join('');
                })
                .catch(error => console.error('승인 대기 목록 로드 실패:', error));
        }

        function loadVerifiedEmployments() {
            fetch('/api/external-employments/admin/verified?page=0&size=50')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('verifiedList');
                    if (data.content.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">승인된 활동이 없습니다.</div>';
                        return;
                    }

                    container.innerHTML = data.content.map(e => createEmploymentCard(e, false)).join('');
                })
                .catch(error => console.error('승인 완료 목록 로드 실패:', error));
        }

        function createEmploymentCard(e, isPending) {
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>${e.companyName}</h5>
                                <p class="text-muted mb-2">
                                    <span class="badge bg-secondary">${e.employmentTypeName}</span>
                                    ${e.position ? ' - ' + e.position : ''}
                                </p>
                                <p class="small mb-2">
                                    <strong>학생:</strong> ${e.userName || 'N/A'} (ID: ${e.userId})<br>
                                    <strong>기간:</strong> ${formatDate(e.startDate)} ~ ${e.endDate ? formatDate(e.endDate) : '진행 중'}
                                    ${e.durationMonths ? ' (' + e.durationMonths + '개월)' : ''}
                                </p>
                                ${e.description ? `<p class="small">${e.description}</p>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                ${isPending ? `
                                    <button class="btn btn-sm btn-primary mb-2" onclick="openVerifyModal(${e.employmentId})">
                                        <i class="fas fa-check"></i> 검토
                                    </button>
                                ` : `
                                    <div class="alert alert-success mb-2">
                                        <strong>가점: ${e.credits}점</strong>
                                    </div>
                                    <small class="text-muted">승인일: ${formatDate(e.verificationDate)}</small>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function openVerifyModal(employmentId) {
            currentEmploymentId = employmentId;

            fetch(`/api/external-employments/${employmentId}`)
                .then(response => response.json())
                .then(e => {
                    document.getElementById('modalEmploymentInfo').innerHTML = `
                        <div class="alert alert-secondary">
                            <strong>${e.companyName}</strong> - ${e.employmentTypeName}<br>
                            학생: ${e.userName} (${e.userId})<br>
                            기간: ${e.durationMonths}개월
                        </div>
                    `;

                    // 자동 계산된 가점 표시
                    fetch(`/api/external-employments/calculate-credits?employmentType=${e.employmentType}&durationMonths=${e.durationMonths}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('creditsInput').value = data.credits;
                        });

                    new bootstrap.Modal(document.getElementById('verifyModal')).show();
                });
        }

        document.getElementById('approveBtn').addEventListener('click', function() {
            const credits = document.getElementById('creditsInput').value;
            verifyEmployment(true, credits, null);
        });

        document.getElementById('rejectBtn').addEventListener('click', function() {
            document.getElementById('rejectionReasonDiv').style.display = 'block';
            document.getElementById('approveBtn').style.display = 'none';
            document.getElementById('rejectBtn').textContent = '거절 확정';
            document.getElementById('rejectBtn').onclick = function() {
                const reason = document.getElementById('rejectionReasonInput').value;
                if (!reason) {
                    alert('거절 사유를 입력해주세요.');
                    return;
                }
                verifyEmployment(false, 0, reason);
            };
        });

        function verifyEmployment(approve, credits, rejectionReason) {
            fetch(`/api/external-employments/${currentEmploymentId}/verify`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    approve: approve,
                    credits: parseInt(credits) || 0,
                    rejectionReason: rejectionReason
                })
            })
            .then(response => response.json())
            .then(() => {
                alert(approve ? '승인되었습니다.' : '거절되었습니다.');
                bootstrap.Modal.getInstance(document.getElementById('verifyModal')).hide();
                loadStatistics();
                loadPendingEmployments();
                loadVerifiedEmployments();
            })
            .catch(error => {
                console.error('검토 처리 실패:', error);
                alert('처리 중 오류가 발생했습니다.');
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('ko-KR');
        }
    </script>
</div>
</body>
</html>
