<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>외부취업 활동 등록</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="fas fa-plus-circle"></i> 외부취업 활동 등록</h3>
                    </div>
                    <div class="card-body">
                        <form id="employmentForm">
                            <!-- 활동 유형 -->
                            <div class="mb-3">
                                <label for="employmentType" class="form-label">활동 유형 <span class="text-danger">*</span></label>
                                <select class="form-select" id="employmentType" required>
                                    <option value="">선택하세요</option>
                                    <option th:each="type : ${employmentTypes}"
                                            th:value="${type.name()}"
                                            th:text="${type.displayName} + ' - ' + ${type.description}"></option>
                                </select>
                            </div>

                            <!-- 회사/기관명 -->
                            <div class="mb-3">
                                <label for="companyName" class="form-label">회사/기관명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyName" required maxlength="200">
                            </div>

                            <!-- 직위/직책 -->
                            <div class="mb-3">
                                <label for="position" class="form-label">직위/직책</label>
                                <input type="text" class="form-control" id="position" maxlength="100">
                            </div>

                            <!-- 부서 -->
                            <div class="mb-3">
                                <label for="department" class="form-label">부서</label>
                                <input type="text" class="form-control" id="department" maxlength="100">
                            </div>

                            <!-- 활동 기간 -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="startDate" class="form-label">시작일 <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="startDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="endDate" class="form-label">종료일</label>
                                    <input type="date" class="form-control" id="endDate">
                                    <small class="text-muted">진행 중인 경우 비워두세요</small>
                                </div>
                            </div>

                            <!-- 예상 가점 표시 -->
                            <div id="creditsPreview" class="alert alert-info" style="display:none;">
                                <i class="fas fa-info-circle"></i>
                                <strong>예상 가점:</strong> <span id="estimatedCredits">0</span>점
                                <small class="d-block mt-1">* 관리자 승인 시 부여되는 가점입니다.</small>
                            </div>

                            <!-- 활동 설명 -->
                            <div class="mb-3">
                                <label for="description" class="form-label">활동 설명</label>
                                <textarea class="form-control" id="description" rows="3" maxlength="2000"></textarea>
                            </div>

                            <!-- 업무 내용 -->
                            <div class="mb-3">
                                <label for="workContent" class="form-label">업무 내용</label>
                                <textarea class="form-control" id="workContent" rows="3" maxlength="2000"></textarea>
                            </div>

                            <!-- 습득한 기술 -->
                            <div class="mb-3">
                                <label for="skillsLearned" class="form-label">습득한 기술</label>
                                <textarea class="form-control" id="skillsLearned" rows="2" maxlength="1000"></textarea>
                            </div>

                            <!-- 증명서 URL -->
                            <div class="mb-3">
                                <label for="certificateUrl" class="form-label">증명서 URL</label>
                                <input type="url" class="form-control" id="certificateUrl" maxlength="500"
                                       placeholder="https://...">
                                <small class="text-muted">재직증명서, 수료증 등의 증빙 자료 URL을 입력하세요.</small>
                            </div>

                            <!-- 버튼 -->
                            <div class="d-flex justify-content-between">
                                <a href="/external-employment" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> 취소
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 등록
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // 가점 자동 계산
        document.getElementById('employmentType').addEventListener('change', calculateCredits);
        document.getElementById('startDate').addEventListener('change', calculateCredits);
        document.getElementById('endDate').addEventListener('change', calculateCredits);

        function calculateCredits() {
            const employmentType = document.getElementById('employmentType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!employmentType || !startDate) {
                document.getElementById('creditsPreview').style.display = 'none';
                return;
            }

            // 기간(개월) 계산
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const months = Math.floor((end - start) / (1000 * 60 * 60 * 24 * 30));

            if (months < 0) {
                document.getElementById('creditsPreview').style.display = 'none';
                return;
            }

            // API 호출하여 가점 계산
            fetch(`/api/external-employments/calculate-credits?employmentType=${employmentType}&durationMonths=${months}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('estimatedCredits').textContent = data.credits;
                    document.getElementById('creditsPreview').style.display = 'block';
                })
                .catch(error => {
                    console.error('가점 계산 실패:', error);
                });
        }

        // 폼 제출
        document.getElementById('employmentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const requestData = {
                employmentType: document.getElementById('employmentType').value,
                companyName: document.getElementById('companyName').value,
                position: document.getElementById('position').value,
                department: document.getElementById('department').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value || null,
                description: document.getElementById('description').value,
                workContent: document.getElementById('workContent').value,
                skillsLearned: document.getElementById('skillsLearned').value,
                certificateUrl: document.getElementById('certificateUrl').value
            };

            fetch('/api/external-employments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('등록 실패');
            })
            .then(data => {
                alert('외부취업 활동이 등록되었습니다.\n관리자 승인 후 가점이 부여됩니다.');
                window.location.href = '/external-employment';
            })
            .catch(error => {
                console.error('등록 실패:', error);
                alert('활동 등록에 실패했습니다.');
            });
        });
    </script>
</div>
</body>
</html>
