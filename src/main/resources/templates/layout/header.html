<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="header">
<header class="header">
    <div class="header-container">
        <!-- 로고 -->
        <a href="/" class="header-logo">
            <div class="logo-wrapper">
                <span class="logo-badge">WellTech</span>
                <span class="logo-main">푸름대학교</span>
                <span class="logo-sub">POOREUM UNIVERSITY</span>
            </div>
        </a>

        <!-- 메인 네비게이션 -->
        <nav>
            <ul class="header-nav">
                <li class="header-nav-item">
                    <a href="/programs" class="header-nav-link">CHAMP 비교과 프로그램</a>
                </li>
                <li class="header-nav-item">
                    <a href="/mileage" class="header-nav-link">CHAMP 마일리지</a>
                </li>
                <li class="header-nav-item">
                    <a href="/counseling" class="header-nav-link">통합상담</a>
                </li>
                <li class="header-nav-item">
                    <a href="/assessment" class="header-nav-link">역량진단</a>
                </li>
                <li class="header-nav-item">
                    <a href="/portfolio" class="header-nav-link">포트폴리오</a>
                </li>
                <li class="header-nav-item">
                    <a href="/survey" class="header-nav-link">설문조사</a>
                </li>
            </ul>
        </nav>

        <!-- 우측 액션 버튼 -->
        <div class="header-actions">
            <a href="/external-employment" class="header-link">외부취업가점</a>
            <span class="header-divider">|</span>
            <!-- 이름 표시: 내부회원 또는 외부회원 -->
            <span th:if="${session.name != null or session.externalUserName != null}" class="header-link"
                  th:text="${session.name != null ? session.name : session.externalUserName} + '님'"></span>
            <!-- 알림 아이콘 (내부회원 로그인 시에만 표시) -->
            <span th:if="${session.userId != null}" class="header-divider">|</span>
            <a th:if="${session.userId != null}" href="/notifications" class="header-link notification-link" id="notificationIcon">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align: middle;">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
                <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
            </a>
            <!-- 마이페이지 (로그인 시에만 표시) -->
            <span th:if="${session.userId != null or session.externalUserId != null}" class="header-divider">|</span>
            <a th:if="${session.userId != null or session.externalUserId != null}" href="/mypage" class="header-link">마이페이지</a>
            <!-- 상담 관리 (상담사/관리자만) -->
            <span th:if="${session.role != null and (session.role.name() == 'COUNSELOR' or session.role.name() == 'ADMIN')}" class="header-divider">|</span>
            <a th:if="${session.role != null and session.role.name() == 'COUNSELOR'}" href="/counseling/manage" class="btn-admin">상담 관리</a>
            <!-- 관리 (관리자만) -->
            <span th:if="${session.isAdmin == true}" class="header-divider">|</span>
            <a th:if="${session.isAdmin == true}" href="/admin/programs" class="btn-admin">관리</a>
            <!-- 로그인 (비로그인 시에만 표시) -->
            <span th:if="${session.userId == null and session.externalUserId == null}" class="header-divider">|</span>
            <a th:if="${session.userId == null and session.externalUserId == null}" href="/login" class="header-link">로그인</a>
            <!-- 로그아웃 (로그인 시에만 표시) -->
            <span th:if="${session.userId != null or session.externalUserId != null}" class="header-divider">|</span>
            <a th:if="${session.userId != null or session.externalUserId != null}" href="/logout" class="btn-logout">로그아웃</a>
            <button class="btn-search" aria-label="검색">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>

        <!-- 알림 개수 업데이트 스크립트 (내부회원만) -->
        <script th:if="${session.userId != null}">
            // 페이지 로드 시 알림 개수 가져오기
            function updateNotificationCount() {
                console.log('[알림] API 호출 시작:', new Date().toLocaleTimeString());

                fetch('/api/notifications/unread-count')
                    .then(response => {
                        console.log('[알림] 응답 상태:', response.status);
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[알림] 응답 데이터:', data);
                        const badge = document.getElementById('notificationBadge');
                        if (data.count > 0) {
                            badge.textContent = data.count;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('[알림] 오류 발생:', error);
                        console.error('[알림] 오류 상세:', error.message, error.stack);
                    });
            }

            // 페이지 로드 시 실행
            console.log('[알림] 스크립트 로드됨, userId:', '[[${session.userId}]]');
            updateNotificationCount();

            // 30초마다 알림 개수 업데이트
            setInterval(updateNotificationCount, 30000);
        </script>

        <style>
            .notification-link {
                position: relative;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .notification-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                background-color: #dc3545;
                color: white;
                border-radius: 10px;
                padding: 2px 6px;
                font-size: 11px;
                font-weight: bold;
                min-width: 18px;
                text-align: center;
            }
        </style>
    </div>
</header>
</html>
